<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jinx Game</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QTBX2M9ZK4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} // eslint-disable-line no-unused-vars
    gtag('js', new Date());
    gtag('config', 'G-QTBX2M9ZK4');
  </script>
  <style>
    :root {
      --primary-color: #6c63ff;
      --secondary-color: #ffd369;
      --text-color: #333;
      --button-hover: #4b47c3;
      --danger: #ff5f6d;
    }

    html, body { height: 100%; margin: 0; padding: 0; }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #6c63ff, #ffd369);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 12px;
    }

    #app {
      margin: 20px;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      background: linear-gradient(145deg, #ffffff, #e6e6e6);
      max-width: 760px;
      width: 100%;
      margin-bottom: 56px;
    }

    h1, h2, h3 { color: var(--primary-color); margin-top: 0; }

    .screen { display: none; }
    .screen.active { display: block; }

    input, select {
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
    }

    .button {
      display: inline-block;
      padding: 12px 20px;
      margin: 8px 8px 0 0;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      color: #fff;
      background-color: var(--primary-color);
      cursor: pointer;
      transition: background-color 0.25s ease;
    }

    .button:hover { background-color: var(--button-hover); }
    .button.secondary { background: #434368; }
    .button.warning { background: var(--danger); }
    .button[disabled] { opacity: 0.55; cursor: not-allowed; }

    .menu-grid, .entry-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 16px;
    }

    .card {
      background: #f4f5ff;
      border: 1px solid #dfe1ff;
      border-radius: 12px;
      padding: 14px;
      text-align: left;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(108, 99, 255, 0.12);
      color: var(--primary-color);
      font-weight: 700;
      margin-right: 8px;
      margin-bottom: 12px;
    }

    .status {
      background: #f1f5ff;
      border: 1px solid #dde4ff;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
    }

    .players-list {
      list-style: none;
      padding: 8px 12px;
      border-radius: 10px;
      background: #f5f7ff;
      margin: 8px 0 14px;
      text-align: left;
    }

    .players-list li {
      padding: 6px 0;
      border-bottom: 1px solid #e7e8f2;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .players-list li:last-child { border-bottom: none; }
    .player-name { flex: 1; }

    .mini-btn {
      border: none;
      background: var(--danger);
      color: #fff;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 700;
      margin: 0;
    }

    .question {
      font-size: 18px;
      font-weight: bold;
      color: #2b2b58;
      margin: 16px 0;
      min-height: 24px;
    }

    .result {
      font-size: 16px;
      font-weight: 700;
      margin-top: 8px;
      color: #444;
      min-height: 22px;
    }

    .hint { font-size: 14px; color: #555; }

    #contact-developer {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: var(--secondary-color);
      color: #fff;
      padding: 10px 16px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: 700;
      text-decoration: none;
      z-index: 30;
    }

    footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: max(8px, env(safe-area-inset-bottom));
      width: 100%;
      color: #fff;
      padding: 8px 0;
      font-size: 14px;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      pointer-events: none;
    }

    footer a { color: #fff; text-decoration: none; pointer-events: auto; }

    @media (max-width: 600px) {
      .button { font-size: 14px; padding: 10px 16px; }
    }
  </style>
</head>
<body>
  <a id="contact-developer" href="https://www.instagram.com/om_kangane07" target="_blank">Contact Developer</a>

  <div id="app">
    <h1>Jinx Game</h1>

    <section id="screen-menu" class="screen active">
      <p>Choose how you want to play.</p>
      <div class="menu-grid">
        <div class="card">
          <h3>üì± Local Mode</h3>
          <p>Everyone plays on one phone by passing the device in a circle.</p>
          <button class="button" id="go-local">Play Local</button>
        </div>
        <div class="card">
          <h3>üåê Multiplayer Mode</h3>
          <p>Separate lobby and game screens, all in one file.</p>
          <button class="button secondary" id="go-multi-entry">Play Multiplayer</button>
        </div>
      </div>
    </section>

    <section id="screen-local" class="screen">
      <h2>Local Mode</h2>
      <label for="players">Enter player names (comma-separated):</label>
      <input type="text" id="players" placeholder="e.g., Om, Sandip, Akshay" />
      <p class="hint">Tip: Add at least 3 players for maximum suspense.</p>
      <button class="button" id="start-local">Start Game</button>

      <div id="local-game" style="display:none; margin-top: 14px;">
        <div id="round-indicator" class="badge">Round 1</div>
        <h3 id="current-player"></h3>
        <p id="question-area" class="question" style="display:none;">Question: <span id="question"></span></p>
        <button id="ask-question" class="button">Give Question</button>
        <button id="flip-coin" class="button" style="display:none;">Flip Coin</button>
      </div>

      <div class="result" id="local-result"></div>
      <button class="button secondary" id="back-from-local">Back to Main Menu</button>
    </section>

    <section id="screen-multi-entry" class="screen">
      <h2>Realtime Multiplayer Lobby</h2>
      <p class="hint">Create or join lobby first, then game opens in dedicated Game screen.</p>
      <div class="entry-grid">
        <div class="card">
          <h3>Create Lobby</h3>
          <input id="host-name" placeholder="Your name" maxlength="20" />
          <button class="button" id="create-btn" disabled>Create Lobby</button>
        </div>
        <div class="card">
          <h3>Join Lobby</h3>
          <input id="join-name" placeholder="Your name" maxlength="20" />
          <input id="join-code" placeholder="Lobby code" maxlength="6" />
          <button class="button secondary" id="join-btn" disabled>Join Lobby</button>
        </div>
      </div>
      <div id="entry-error" class="result"></div>
      <div id="socket-status" class="hint">Connecting to server...</div>
      <button id="retry-connect-btn" class="button secondary" style="display:none;">Retry Connection</button>
      <br />
      <button class="button secondary" id="back-from-entry">Back to Main Menu</button>
    </section>

    <section id="screen-lobby" class="screen">
      <h2>Lobby Screen</h2>
      <span id="code-badge" class="badge"></span>
      <span id="round-badge" class="badge"></span>
      <div class="status">
        <strong>Status:</strong> <span id="turn-text">Waiting...</span><br />
        <strong>Host:</strong> <span id="host-text">-</span>
      </div>

      <h3>Players</h3>
      <ul id="players-list" class="players-list"></ul>

      <button id="start-btn" class="button secondary" style="display:none;">Start Game</button>
      <button id="open-game-btn" class="button" style="display:none;">Open Game Screen</button>
      <button class="button secondary" id="back-from-lobby">Back to Menu</button>

      <div class="result" id="lobby-status"></div>
    </section>

    <section id="screen-game" class="screen">
      <h2>Game Screen</h2>
      <span id="code-badge-game" class="badge"></span>
      <span id="round-badge-game" class="badge"></span>

      <div class="status">
        <strong>Turn:</strong> <span id="turn-text-game">Waiting...</span><br />
        <strong>Host:</strong> <span id="host-text-game">-</span>
      </div>

      <div>
        <button id="ask-btn" class="button">Give Question</button>
        <button id="flip-btn" class="button">Flip Coin</button>
        <button id="next-btn" class="button warning">Next Turn</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;margin-top:10px;">
        <select id="answer-player-select">
          <option value="">Choose player name as your answer</option>
        </select>
        <button id="answer-btn" class="button secondary">Answer Name</button>
      </div>

      <div id="answer-text" class="result"></div>
      <div id="question-text" class="question"></div>
      <div id="coin-text" class="result"></div>
      <div id="game-status" class="result"></div>

      <button class="button secondary" id="back-to-lobby">Back to Lobby Screen</button>
    </section>
  </div>

  <footer>
    &copy; 2025 Jinx. All rights reserved. | <a href="privacy-policy.html" target="_blank">Privacy Policy</a>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const screens = {
      menu: document.getElementById('screen-menu'),
      local: document.getElementById('screen-local'),
      entry: document.getElementById('screen-multi-entry'),
      lobby: document.getElementById('screen-lobby'),
      game: document.getElementById('screen-game')
    };

    function showScreen(name) {
      Object.values(screens).forEach((screen) => screen.classList.remove('active'));
      screens[name].classList.add('active');
    }

    // -------- Local mode --------
    let players = [];
    let currentQuestion = '';
    let roundNumber = 1;
    let playerQueue = [];
    let questionQueue = [];

    const questions = [
      'Who would survive the longest in a zombie apocalypse?',
      'Who has the best smile?',
      'Who is most likely to show up late to their own wedding?',
      'Who is the funniest person here?',
      'Who is most likely to start a dramatic rumor by accident?',
      'Who is most likely to brighten your day?',
      'Who is most likely to forget where they parked?',
      'Who has the kindest heart?',
      'Who is most likely to send a text to the wrong person?',
      'Who has the most contagious laugh?',
      'Who is the biggest drama magnet?',
      'Who is the best storyteller?'
    ];

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function nextLocalPlayer() {
      if (!playerQueue.length) {
        roundNumber += 1;
        playerQueue = shuffleArray(players);
      }

      const playerName = playerQueue.pop();
      document.getElementById('current-player').textContent = `${playerName}'s Turn`;
      document.getElementById('round-indicator').textContent = `Round ${roundNumber}`;
      document.getElementById('ask-question').style.display = 'inline-block';
      document.getElementById('flip-coin').style.display = 'none';
      document.getElementById('question-area').style.display = 'none';
      document.getElementById('local-result').textContent = '';
    }

    document.getElementById('start-local').addEventListener('click', () => {
      players = document.getElementById('players').value.split(',').map((n) => n.trim()).filter(Boolean);
      players = [...new Set(players)];
      if (players.length < 2) {
        document.getElementById('local-result').textContent = 'Please enter at least two valid player names.';
        return;
      }
      roundNumber = 1;
      playerQueue = shuffleArray(players);
      questionQueue = shuffleArray(questions);
      document.getElementById('local-game').style.display = 'block';
      nextLocalPlayer();
    });

    document.getElementById('ask-question').addEventListener('click', () => {
      if (!questionQueue.length) questionQueue = shuffleArray(questions);
      currentQuestion = questionQueue.pop();
      document.getElementById('question').textContent = currentQuestion;
      document.getElementById('question-area').style.display = 'block';
      document.getElementById('ask-question').style.display = 'none';
      document.getElementById('flip-coin').style.display = 'inline-block';
    });

    document.getElementById('flip-coin').addEventListener('click', () => {
      const result = Math.random() < 0.5 ? 'Heads' : 'Tails';
      document.getElementById('local-result').textContent = result === 'Heads'
        ? `Coin: Heads ‚Äî Question revealed: ${currentQuestion}`
        : 'Coin: Tails ‚Äî Question stays a mystery.';
      nextLocalPlayer();
    });

    // -------- Multiplayer mode (single-file with separate screens) --------
    const socket = io({ autoConnect: false, reconnectionAttempts: 4, timeout: 5000 });
    let myId = null;
    let lobbyState = null;
    let connectWaitTimer = null;

    const createBtn = document.getElementById('create-btn');
    const joinBtn = document.getElementById('join-btn');
    const entryError = document.getElementById('entry-error');
    const socketStatus = document.getElementById('socket-status');
    const retryConnectBtn = document.getElementById('retry-connect-btn');

    const codeBadge = document.getElementById('code-badge');
    const roundBadge = document.getElementById('round-badge');
    const turnText = document.getElementById('turn-text');
    const hostText = document.getElementById('host-text');
    const playersList = document.getElementById('players-list');
    const startBtn = document.getElementById('start-btn');
    const openGameBtn = document.getElementById('open-game-btn');
    const lobbyStatus = document.getElementById('lobby-status');

    const codeBadgeGame = document.getElementById('code-badge-game');
    const roundBadgeGame = document.getElementById('round-badge-game');
    const turnTextGame = document.getElementById('turn-text-game');
    const hostTextGame = document.getElementById('host-text-game');
    const askBtn = document.getElementById('ask-btn');
    const flipBtn = document.getElementById('flip-btn');
    const nextBtn = document.getElementById('next-btn');
    const answerPlayerSelect = document.getElementById('answer-player-select');
    const answerBtn = document.getElementById('answer-btn');
    const answerText = document.getElementById('answer-text');
    const questionText = document.getElementById('question-text');
    const coinText = document.getElementById('coin-text');
    const gameStatus = document.getElementById('game-status');

    function showError(message) {
      entryError.textContent = message || '';
    }

    function storeSession(code, playerKey) {
      localStorage.setItem('jinxSession', JSON.stringify({ code, playerKey }));
    }

    function getSession() {
      const raw = localStorage.getItem('jinxSession');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (_) { return null; }
    }

    function clearSession() {
      localStorage.removeItem('jinxSession');
    }

    function updateConnectionUI() {
      const connected = socket.connected;
      createBtn.disabled = !connected;
      joinBtn.disabled = !connected;
      retryConnectBtn.style.display = connected ? 'none' : 'inline-block';
      socketStatus.textContent = connected
        ? 'Connected.'
        : 'Connecting to server... If this takes too long, tap Retry Connection.';
    }

    function startConnectWatchdog() {
      if (connectWaitTimer) clearTimeout(connectWaitTimer);
      connectWaitTimer = setTimeout(() => {
        if (!socket.connected) {
          socketStatus.textContent = 'Unable to reach server. Tap Retry Connection.';
          showError('Could not connect to realtime server. Please retry.');
        }
      }, 5000);
    }

    function emitWithAck(event, payload, callback) {
      if (!socket.connected) {
        showError('Still connecting to server. Please wait a moment.');
        return;
      }

      let settled = false;
      const timeoutId = setTimeout(() => {
        if (settled) return;
        settled = true;
        showError('Server did not respond. Please retry.');
      }, 6000);

      socket.emit(event, payload, (response) => {
        if (settled) return;
        settled = true;
        clearTimeout(timeoutId);
        callback(response);
      });
    }

    function playerById(id) {
      return (lobbyState?.players || []).find((p) => p.id === id);
    }

    function currentTurnPlayer() {
      return lobbyState?.turnPlayer || lobbyState?.players?.[lobbyState.turnIndex] || null;
    }

    function isHost() {
      return lobbyState?.hostId === myId;
    }

    function isMyTurn() {
      return currentTurnPlayer()?.id === myId;
    }

    function renderLobby() {
      if (!lobbyState) return;
      codeBadge.textContent = `Lobby: ${lobbyState.code}`;
      roundBadge.textContent = `Round ${lobbyState.round}`;

      const host = playerById(lobbyState.hostId);
      hostText.textContent = host ? host.name : 'Unknown';

      playersList.innerHTML = '';
      lobbyState.players.forEach((p) => {
        const li = document.createElement('li');
        const tags = [];
        if (p.id === lobbyState.hostId) tags.push('Host');
        if (p.id === myId) tags.push('You');

        const name = document.createElement('span');
        name.className = 'player-name';
        name.textContent = `${p.name}${tags.length ? ` (${tags.join(', ')})` : ''}`;
        li.appendChild(name);

        if (isHost() && !lobbyState.started && p.id !== myId) {
          const removeBtn = document.createElement('button');
          removeBtn.className = 'mini-btn';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', () => socket.emit('remove_player', { targetId: p.id }));
          li.appendChild(removeBtn);
        }

        playersList.appendChild(li);
      });

      if (!lobbyState.started) {
        turnText.textContent = 'Waiting for host to start the game';
        lobbyStatus.textContent = 'Host can remove players before starting.';
      } else {
        turnText.textContent = `${currentTurnPlayer()?.name || 'Unknown'} is playing`;
        lobbyStatus.textContent = 'Game started. Move to Game Screen.';
      }

      startBtn.style.display = (isHost() && !lobbyState.started && lobbyState.players.length >= 2) ? 'inline-block' : 'none';
      openGameBtn.style.display = lobbyState.started ? 'inline-block' : 'none';
    }

    function renderGame() {
      if (!lobbyState) return;
      codeBadgeGame.textContent = `Lobby: ${lobbyState.code}`;
      roundBadgeGame.textContent = `Round ${lobbyState.round}`;
      turnTextGame.textContent = `${currentTurnPlayer()?.name || 'Unknown'} is playing`;
      hostTextGame.textContent = playerById(lobbyState.hostId)?.name || 'Unknown';
      gameStatus.textContent = isMyTurn() ? 'Your move.' : 'Wait for the active player.';

      askBtn.disabled = !(lobbyState.started && isMyTurn() && !lobbyState.questionAsked);
      const canAnswer = lobbyState.started && isMyTurn() && lobbyState.questionAsked && !lobbyState.coinResult;
      answerPlayerSelect.disabled = !canAnswer;
      answerBtn.disabled = !canAnswer || !answerPlayerSelect.value;
      flipBtn.disabled = !(canAnswer && !!lobbyState.answerByPlayerId);
      nextBtn.disabled = !(lobbyState.started && lobbyState.coinResult && (isMyTurn() || isHost()));

      answerPlayerSelect.innerHTML = '<option value="">Choose player name as your answer</option>';
      lobbyState.players.forEach((player) => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = player.name;
        if (player.id === lobbyState.answerByPlayerId) option.selected = true;
        answerPlayerSelect.appendChild(option);
      });

      if (!lobbyState.started) {
        questionText.textContent = '';
        answerText.textContent = '';
        coinText.textContent = '';
        return;
      }

      if (lobbyState.questionAsked) {
        const canSeeQuestion = lobbyState.questionVisible || isMyTurn();
        questionText.textContent = canSeeQuestion
          ? `Question: ${lobbyState.currentQuestion}`
          : 'Question selected. Waiting for coin toss result.';
      } else {
        questionText.textContent = '';
      }

      answerText.textContent = lobbyState.answerByPlayerName
        ? `Chosen answer: ${lobbyState.answerByPlayerName}`
        : (lobbyState.questionAsked ? 'Waiting for active player to answer with a name.' : '');

      if (lobbyState.coinResult) {
        coinText.textContent = lobbyState.coinResult === 'Heads'
          ? 'Coin: Heads ‚Äî Question is revealed.'
          : 'Coin: Tails ‚Äî Question stays a mystery.';
      } else {
        coinText.textContent = '';
      }
    }

    function applyStateAndRoute() {
      if (!lobbyState) return;
      renderLobby();
      renderGame();
      if (lobbyState.started) showScreen('game');
      else showScreen('lobby');
    }

    socket.on('connect', () => {
      myId = socket.id;
      if (connectWaitTimer) clearTimeout(connectWaitTimer);
      updateConnectionUI();
      const session = getSession();
      if (session?.code && session?.playerKey) {
        socket.emit('reconnect_lobby', session, (response) => {
          if (!response?.ok) return;
          lobbyState = response.state;
          applyStateAndRoute();
        });
      }
    });

    socket.on('disconnect', () => {
      updateConnectionUI();
      startConnectWatchdog();
    });

    socket.on('connect_error', () => {
      socketStatus.textContent = 'Unable to reach server. Tap Retry Connection.';
      showError('Realtime server unavailable. Check internet and retry.');
      retryConnectBtn.style.display = 'inline-block';
    });

    socket.on('lobby_state', (state) => {
      lobbyState = state;
      applyStateAndRoute();
    });

    socket.on('player_removed', ({ targetId }) => {
      if (targetId === myId) {
        clearSession();
        lobbyState = null;
        showScreen('menu');
      }
    });

    // navigation
    document.getElementById('go-local').addEventListener('click', () => showScreen('local'));
    document.getElementById('go-multi-entry').addEventListener('click', () => showScreen('entry'));
    document.getElementById('back-from-local').addEventListener('click', () => showScreen('menu'));
    document.getElementById('back-from-entry').addEventListener('click', () => showScreen('menu'));
    document.getElementById('back-from-lobby').addEventListener('click', () => showScreen('menu'));
    document.getElementById('back-to-lobby').addEventListener('click', () => showScreen('lobby'));

    createBtn.addEventListener('click', () => {
      const name = document.getElementById('host-name').value.trim();
      emitWithAck('create_lobby', { name }, (response) => {
        if (!response?.ok) {
          showError(response?.error || 'Could not create lobby.');
          return;
        }
        showError('');
        storeSession(response.code, response.playerKey);
        lobbyState = response.state;
        applyStateAndRoute();
      });
    });

    joinBtn.addEventListener('click', () => {
      const name = document.getElementById('join-name').value.trim();
      const code = document.getElementById('join-code').value.trim().toUpperCase();
      emitWithAck('join_lobby', { name, code }, (response) => {
        if (!response?.ok) {
          showError(response?.error || 'Could not join lobby.');
          return;
        }
        showError('');
        storeSession(response.code, response.playerKey);
        lobbyState = response.state;
        applyStateAndRoute();
      });
    });

    startBtn.addEventListener('click', () => socket.emit('start_game'));
    openGameBtn.addEventListener('click', () => showScreen('game'));

    askBtn.addEventListener('click', () => socket.emit('ask_question'));
    answerBtn.addEventListener('click', () => {
      const targetId = answerPlayerSelect.value;
      if (!targetId) return;
      socket.emit('answer_player', { targetId });
    });
    flipBtn.addEventListener('click', () => socket.emit('flip_coin'));
    nextBtn.addEventListener('click', () => socket.emit('next_turn'));
    answerPlayerSelect.addEventListener('change', () => {
      const canAnswer = lobbyState && lobbyState.started && isMyTurn() && lobbyState.questionAsked && !lobbyState.coinResult;
      answerBtn.disabled = !canAnswer || !answerPlayerSelect.value;
    });

    retryConnectBtn.addEventListener('click', () => {
      showError('');
      socket.connect();
      startConnectWatchdog();
    });

    updateConnectionUI();
    socket.connect();
    startConnectWatchdog();
  </script>
</body>
</html>
